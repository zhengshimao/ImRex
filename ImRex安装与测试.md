# ImRex安装与测试

## 地址

github：https://github.com/pmoris/ImRex/

文章：Moris, Pieter, Joey De Pauw, Anna Postovskaya, Sofie Gielis, Nicolas De Neuter, Wout Bittremieux, Benson Ogunjimi, Kris Laukens, and Pieter Meysman. “Current Challenges for Unseen-Epitope TCR Interaction Prediction and a New Perspective Derived from Image Classification.” Briefings in Bioinformatics 22, no. 4 (2020). https://doi.org/10.1093/bib/bbaa318

文件附件数据Zenodo data：https://zenodo.org/records/3973547

## 安装

-  根据 ` environment.yml` 在conda下安装相关模块

```sh
$ git clone https://github.com/pmoris/ImRex.git
$ cd ImRex
# 根据  environment.yml 在conda下安装
 $ conda create -n deepTCR
 $ conda activate deepTCR
 $ conda install   python==3.7.6   tensorflow-gpu==2.1.0   tensorboard==2.1.0   cudatoolkit==10.1.243   cudnn==7.6.5   h5py==2.10.0   hdf5==1.10.4   biopython==1.76   ipykernel   joblib==0.14.1   matplotlib==3.1.3   numpy==1.18.1   pandas==1.0.1   pillow==7.0.0   pyteomics==4.2   pytest==5.3.5   scikit-learn==0.22.1   scipy==1.5.0   tqdm==4.42.1   requests==2.22.0   requests-futures==1.0.0   seaborn==0.10.0   python-Levenshtein==0.12.0   pip==20.0.2
```

## 准备输入文件

- 来自gtihub说明界面

```sh
$ cat input-sequences.csv
cdr3;antigen.epitope
CAVTDDKIIF;LLWNGPMAV
CAVDSGGYQKVTF;LLWNGPMAV
CAGGDDKIIF;LLWNGPMAV
CAVKDARLMF;LLWNGPMAV
CAVGSDKIIF;LLWNGPMAV
CAVSDARLMF;LLWNGPMAV
CAAFDDKIIF;LLWNGPMAV
CAASASKLIF;LLWNGPMAV
CAVDTNAGKSTF;LLWNGPMAV
```

## 测试运行

- 使用预构建的模型

- 执行文件`predict.py` 与本地模块相对路径有问题，将其复制到合适路径下。

```sh
# python ./src/scripts/predict/predict.py --model models/pretrained/2020-07-24_19-18-39_trbmhcidown-shuffle-padded-b32-lre4-reg001/2020-07-24_19-18-39_trbmhcidown-shuffle-padded-b32-lre4-reg001.h5 --input input-sequences.csv --output output-predictions.csv
$ cp ./src/scripts/predict/predict.py ./
$ python predict.py --model models/pretrained/2020-07-24_19-18-39_trbmhcidown-shuffle-padded-b32-lre4-reg001/2020-07-24_19-18-39_trbmhcidown-shuffle-padded-b32-lre4-reg001.h5 --input input-sequences.csv --output output-predictions.csv
```

## 结果文件

```sh
$ cat output-predictions.csv
cdr3,antigen.epitope,prediction_score
CAVTDDKIIF,LLWNGPMAV,0.2512429
CAVDSGGYQKVTF,LLWNGPMAV,0.15825216
CAGGDDKIIF,LLWNGPMAV,0.31194922
CAVKDARLMF,LLWNGPMAV,0.8013551
CAVGSDKIIF,LLWNGPMAV,0.16477294
CAVSDARLMF,LLWNGPMAV,0.49530065
CAAFDDKIIF,LLWNGPMAV,0.6289945
CAASASKLIF,LLWNGPMAV,0.18411127
CAVDTNAGKSTF,LLWNGPMAV,0.12587573

```

## 文章数据

Contains: 包含：

- Trained model files (.h5)
  经过训练的模型文件 （.h5）
- Associated train and validation datasets for each model.
  每个模型的关联训练和验证数据集。
- Learning curves and evaluation metrics.
  学习曲线和评估指标。
- Log files with training and data arguments (full training scripts are available in GitHub repository).
  包含训练和数据参数的日志文件（完整的训练脚本可在 GitHub 存储库中找到）。
- Comparisons between different models.
  不同型号之间的比较。
- Complete raw and processed datasets (also available in the associated GitHub repository).
  完整的原始数据集和已处理的数据集（也可在关联的 GitHub 存储库中找到）。

**Please refer to the associated GitHub repository (https://github.com/pmoris/ImRex) for more information on the directory structure and contents, as well as the scripts that generated these output files.
请参阅关联的 GitHub 存储库 （ https://github.com/pmoris/ImRex） 以获取有关目录结构和内容以及生成这些输出文件的脚本的更多信息。**

**Contents: 内容：**

- `data.zip`: Contains raw and preprocessed datasets. READMEs in subdirectory describe the data sources and preprocessing steps. Please refer to the associated GitHub repository for the specific scripts that generated these files. Note that the full training and test sets (i.e. containing both positive and negative examples) are stored separately for each model/CV iteration in the `models` archives.
  `data.zip` ：包含原始数据集和预处理数据集。子目录中的自述文件描述数据源和预处理步骤。请参阅关联的 GitHub 存储库，了解生成这些文件的特定脚本。请注意，对于 `models` 每个模型/CV 迭代，完整的训练集和测试集（即包含正面和负面示例）都单独存储在存档中。
- `models-main.zip`: contains the trained models and evaluation metrics for the main different experiments described in the bash and pbs scripts in `./src/scripts/hpc_scripts`. Log files for the experiments outlined here can be found in `./src/scripts/hpc_scripts`.
  `models-main.zip` ：包含 中的 `./src/scripts/hpc_scripts` bash 和 pbs 脚本中描述的主要不同实验的训练模型和评估指标。此处概述的实验的日志文件可在 `./src/scripts/hpc_scripts` 中找到。
- `models-full.zip`: contains models that were trained on the complete VDJdb dataset without cross-validation, filtered on human TRB data, no 10x data and restricted to 10-20 (CDR3) or 8-11 (epitope) amino acid residues, with negatives that were generated by shuffling (i.e. sampling an negative epitope for each positive CDR3 sequence). One set of models uses downsampling to reduce the most abundant epitopes down to 400 pairs each, the other one does not use any downsampling. These models were also used for evaluating on the external Adaptive dataset, as outlined in `./src/scripts/evaluate/evaluate_adaptive.sh`, and the TRA subset of sequences (`./src/scripts/evaluate/evaluate_tra.sh`).
  `models-full.zip` ：包含在整个 VDJdb 数据集上训练的模型，无需交叉验证，根据人类 TRB 数据进行过滤，没有 10x 数据，并且限制为 10-20 （CDR3） 或 8-11（表位）氨基酸残基，阴性通过洗牌生成（即对每个阳性 CDR3 序列采样阴性表位）。一组模型使用下采样将最丰富的表位减少到每对 400 对，另一组模型不使用任何下采样。这些模型还用于评估外部自适应数据集，如 中 `./src/scripts/evaluate/evaluate_adaptive.sh` 所述，以及序列的 TRA 子集 `./src/scripts/evaluate/evaluate_tra.sh` （ ）。
- `models-decoyfit.zip`: contains models that were trained on true data, but evaluated on data where epitopes were replaced by decoys.
  `models-decoyfit.zip` ：包含使用真实数据进行训练的模型，但根据表位被诱饵替换的数据进行评估。
- `models-padded-epitoperatio.zip`: contains a quick test of trained models (padded/interaction map) that use a different type of negative shuffling, see docstrings in `./src/processing/negative_sampler.py` for more info.
  `models-padded-epitoperatio.zip` ：包含对使用不同类型的负洗牌的训练模型（填充/交互映射）的快速测试，有关详细信息，请参阅文档 `./src/processing/negative_sampler.py` 字符串。
- `models-repeat-local.zip`: contains a number of repeated runs from `models-main`, used to estimate variability in model performance for multiple identical runs.
  `models-repeat-local.zip` ：包含从 `models-main` 的多个重复运行，用于估计多个相同运行的模型性能的变异性。
- `comparisons.zip`: contains comparison directories, each consisting of two or more model output directories, that contrast the performance metrics of the models. These outputs were generated by using the `./src/scripts/evaluate/visualize.py` script, or by using the oneliners in `./src/scripts/evaluate/visualise.sh`, which can operate on the entire comparisons directory at once.
  `comparisons.zip` ：包含比较目录，每个目录由两个或多个模型输出目录组成，用于对比模型的性能指标。这些输出是通过使用 `./src/scripts/evaluate/visualize.py` 脚本生成的，或者通过使用 `./src/scripts/evaluate/visualise.sh` 中的 oneliners 生成的，这些 oneliners 可以同时对整个比较目录进行操作。

**Note that any file paths described here are in reference to the associated GitHub repository (https://github.com/pmoris/ImRex).
请注意，此处描述的任何文件路径都引用了关联的 GitHub 存储库 （ https://github.com/pmoris/ImRex）。**

**Overview of different experiments:
不同实验概述：**

- Two main architectures were compared: the interaction map (or `padded`) CNN and a dual input CNN based on NetTCR (`nettcr`).
  比较了两种主要架构：交互映射（或 `padded` ）CNN和基于NetTCR（）的双输入CNN `nettcr` （）。

- Two different cross-validation strategies were used: a 5x repeated 5-fold CV (`repeated5fold`) and an epitope-grouped CV (`epitope_grouped`).
  使用了两种不同的交叉验证策略：5 倍重复的 5 倍 CV （ `repeated5fold` ） 和表位分组的 CV （ `epitope_grouped` ）。

- The different dataset subsets are labelled as follows. Check the Makefile's

  ```
  preprocess-vdjdb-aug-2019
  ```

  command (and the underlying script

  ```
  ./src/scripts/preprocessing/preprocess_vdjdb.py
  ```

  ) for a more thorough overview of the different filtering options.

  
  不同的数据集子集标记如下。检查 Makefile `preprocess-vdjdb-aug-2019` 的命令（和基础脚本 `./src/scripts/preprocessing/preprocess_vdjdb.py` ），以更全面地了解不同的过滤选项。

  - `mhci`: only MHCI class presented epitopes.
    `mhci` ：只有MHCI类呈现表位。
  - `trb`: only TRB CDR3 sequences.
    `trb` ：仅 TRB CDR3 序列。
  - `tra`: only TRA CDR3 sequences.
    `tra` ：仅 TRA CDR3 序列。
  - `tratrb`: both types of CDR3 sequences.
    `tratrb` ：两种类型的 CDR3 序列。
  - `down`: moderate downsampling of most abundant epitopes to 1000 pairs.
    `down` ：将最丰富的表位适度下采样至 1000 对。
  - `down400`: strong downsampling of most abundant epitopes to 400 pairs.
    `down400` ：将最丰富的表位强力下采样至 400 对。
  - `decoy`: decoy epitope data.
    `decoy` ：诱饵表位数据。
  - `reg001`: regularization factor 0.01 (only for padded/interaction type models, fixed value)
    `reg001` ：正则化因子 0.01（仅适用于填充/交互类型模型，固定值）

- Two different methods of generating negative TCR-epitope pairs were used: shuffling of positive pairs, i.e. sampling a single epitope from the positive pairs for each CDR3 sequence (`shuffle`), and sampling CDR3s from a reference repertoire (`negref`).
  使用了两种不同的方法来生成负 TCR-表位对：正对的洗牌，即从每个 CDR3 序列的正对 （ `shuffle` ）中采样单个表位，以及从参考库 （ ） 中采样 CDR3 `negref` 。

- The batch size is labelled as `b32` = a batch size of 32.
  批次大小标记为 `b32` = 批次大小 32。

- The learning rate was always 0.0001 (`lre4`) or 0.001 (`lre3`).
  学习率始终为 0.0001 （ `lre4` ） 或 0.001 （ `lre3` ）。
